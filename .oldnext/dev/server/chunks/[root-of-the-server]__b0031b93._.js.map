{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/EverNurse-Project/evernurse-cv-matcher/src/app/api/upload/route.ts"],"sourcesContent":["// src/app/api/upload/route.ts\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { writeFile, mkdir, readFile } from 'fs/promises';\r\nimport { join } from 'path';\r\n\r\n// Simple file-based database for now\r\nconst DB_FILE = './uploads/database.json';\r\n\r\nasync function readDatabase() {\r\n    try {\r\n        const data = await readFile(DB_FILE, 'utf-8');\r\n        return JSON.parse(data);\r\n    } catch (error) {\r\n        // Return empty database if file doesn't exist\r\n        return { files: [], candidates: [], matches: [] };\r\n    }\r\n}\r\n\r\nasync function writeDatabase(data: any) {\r\n    await mkdir('./uploads', { recursive: true });\r\n    await writeFile(DB_FILE, JSON.stringify(data, null, 2));\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n    console.log('ðŸŽ¯ UPLOAD API CALLED - Processing files...');\r\n\r\n    try {\r\n        const formData = await request.formData();\r\n        const files = formData.getAll('files') as File[];\r\n\r\n        console.log(`ðŸ“ Received ${files.length} file(s)`);\r\n\r\n        if (files.length === 0) {\r\n            return NextResponse.json(\r\n                { error: 'No files provided' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Ensure upload directory exists\r\n        const uploadDir = './uploads';\r\n        await mkdir(uploadDir, { recursive: true });\r\n\r\n        const results = [];\r\n        const db = await readDatabase();\r\n\r\n        // Ensure arrays exist\r\n        if (!db.files) db.files = [];\r\n        if (!db.candidates) db.candidates = [];\r\n        if (!db.matches) db.matches = [];\r\n\r\n        for (const file of files) {\r\n            console.log(`ðŸ“„ Processing: ${file.name} (${file.type})`);\r\n\r\n            try {\r\n                // Validate file type\r\n                const allowedTypes = [\r\n                    'application/pdf',\r\n                    'application/msword',\r\n                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'\r\n                ];\r\n\r\n                if (!allowedTypes.includes(file.type)) {\r\n                    console.log('âŒ Invalid file type');\r\n                    results.push({\r\n                        originalName: file.name,\r\n                        status: 'error',\r\n                        error: `Invalid file type. Only PDF, DOC, and DOCX are allowed.`\r\n                    });\r\n                    continue;\r\n                }\r\n\r\n                // Validate file size (10MB max)\r\n                const maxSize = 10 * 1024 * 1024;\r\n                if (file.size > maxSize) {\r\n                    console.log('âŒ File too large');\r\n                    results.push({\r\n                        originalName: file.name,\r\n                        status: 'error',\r\n                        error: `File too large. Maximum size is 10MB.`\r\n                    });\r\n                    continue;\r\n                }\r\n\r\n                // Save file\r\n                const bytes = await file.arrayBuffer();\r\n                const buffer = Buffer.from(bytes);\r\n                const timestamp = Date.now();\r\n                const safeFilename = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');\r\n                const filename = `${timestamp}-${safeFilename}`;\r\n                const filePath = join(uploadDir, filename);\r\n\r\n                console.log('ðŸ’¾ Saving file...');\r\n                await writeFile(filePath, buffer);\r\n\r\n                // Create file record in our simple database\r\n                const fileRecord = {\r\n                    id: `file-${timestamp}`,\r\n                    filename,\r\n                    originalName: file.name,\r\n                    filePath,\r\n                    fileSize: file.size,\r\n                    mimetype: file.type,\r\n                    status: 'processing',\r\n                    uploadedAt: new Date().toISOString()\r\n                };\r\n\r\n                db.files.push(fileRecord);\r\n                await writeDatabase(db);\r\n\r\n                console.log('âœ… File saved and recorded:', fileRecord.id);\r\n\r\n                results.push({\r\n                    id: fileRecord.id,\r\n                    originalName: file.name,\r\n                    status: 'processing',\r\n                    message: 'File uploaded successfully - ready for parsing'\r\n                });\r\n\r\n            } catch (fileError) {\r\n                console.error(`âŒ Error processing ${file.name}:`, fileError);\r\n                results.push({\r\n                    originalName: file.name,\r\n                    status: 'error',\r\n                    error: `File processing failed: ${fileError instanceof Error ? fileError.message : 'Unknown error'}`\r\n                });\r\n            }\r\n        }\r\n\r\n        console.log('âœ… Upload completed successfully');\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            data: results,\r\n            message: `Processed ${results.length} file(s)`\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('âŒ Upload API error:', error);\r\n        return NextResponse.json(\r\n            {\r\n                success: false,\r\n                error: 'Upload failed',\r\n                details: error instanceof Error ? error.message : 'Unknown error'\r\n            },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n\r\nexport async function GET() {\r\n    try {\r\n        const db = await readDatabase();\r\n        return NextResponse.json({\r\n            message: 'Upload API is working',\r\n            stats: {\r\n                totalFiles: db.files?.length || 0,\r\n                uploadedFiles: db.files?.filter((f: any) => f.status === 'processing').length || 0\r\n            }\r\n        });\r\n    } catch (error) {\r\n        return NextResponse.json({\r\n            message: 'Upload API is working (no database yet)'\r\n        });\r\n    }\r\n}"],"names":[],"mappings":"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"}}]
}