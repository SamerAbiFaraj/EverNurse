{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/EverNurse-Project/evernurse-cv-matcher/src/app/api/results/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { readFile } from 'fs/promises';\r\n\r\n// Reuse the matching engine with improved keyword matching\r\nclass MatchingEngine {\r\n    static calculateMatch(candidate: any, job: any) {\r\n        let score = 0;\r\n        const reasons = [];\r\n\r\n        // Experience match (30 points max)\r\n        if (candidate.experience >= job.minExperience) {\r\n            const expScore = Math.min(30, (candidate.experience / job.minExperience) * 20);\r\n            score += expScore;\r\n            reasons.push(`Experience: ${candidate.experience} years`);\r\n        }\r\n\r\n        // Skills match (40 points max)\r\n        let skillsScore = 0;\r\n        const matchedSkills = candidate.skills.filter((skill: string) =>\r\n            job.requiredSkills.some((reqSkill: string) =>\r\n                reqSkill.toLowerCase().includes(skill.toLowerCase()) ||\r\n                skill.toLowerCase().includes(reqSkill.toLowerCase())\r\n            )\r\n        );\r\n\r\n        if (matchedSkills.length > 0 && job.requiredSkills.length > 0) {\r\n            skillsScore = (matchedSkills.length / job.requiredSkills.length) * 40;\r\n            score += skillsScore;\r\n            reasons.push(`Skills: ${matchedSkills.join(', ')}`);\r\n        } else if (job.requiredSkills.length === 0) {\r\n            // Fallback: Analyze job description for keywords\r\n            const descriptionScore = this.analyzeJobDescription(candidate, job);\r\n            score += descriptionScore.score;\r\n            if (descriptionScore.keywords.length > 0) {\r\n                reasons.push(`Matched keywords: ${descriptionScore.keywords.join(', ')}`);\r\n            }\r\n        }\r\n\r\n        // License match (30 points max)\r\n        let licenseScore = 0;\r\n        const matchedLicenses = candidate.licenses.filter((license: string) =>\r\n            job.requiredLicenses.includes(license)\r\n        );\r\n\r\n        if (matchedLicenses.length > 0 && job.requiredLicenses.length > 0) {\r\n            licenseScore = (matchedLicenses.length / job.requiredLicenses.length) * 30;\r\n            score += licenseScore;\r\n            reasons.push(`Licenses: ${matchedLicenses.join(', ')}`);\r\n        }\r\n\r\n        return {\r\n            score: Math.min(100, Math.round(score)),\r\n            reasons,\r\n            matchedSkills\r\n        };\r\n    }\r\n\r\n    static analyzeJobDescription(candidate: any, job: any) {\r\n        const jobText = `${job.title} ${job.description}`.toLowerCase();\r\n        const candidateText = candidate.rawText.toLowerCase();\r\n\r\n        const keywords = [\r\n            'project management', 'banking', 'credit card', 'fintech', 'it', 'software',\r\n            'development', 'database', 'cloud', 'leadership', 'management', 'strategy',\r\n            'planning', 'agile', 'scrum', 'api', 'integration', 'consulting',\r\n            'nursing', 'healthcare', 'patient care', 'clinical', 'emergency'\r\n        ];\r\n\r\n        const matchedKeywords: string[] = [];\r\n        let keywordMatches = 0;\r\n\r\n        for (const keyword of keywords) {\r\n            if (jobText.includes(keyword) && candidateText.includes(keyword)) {\r\n                matchedKeywords.push(keyword);\r\n                keywordMatches++;\r\n            }\r\n        }\r\n\r\n        for (const skill of candidate.skills) {\r\n            if (jobText.includes(skill.toLowerCase()) && !matchedKeywords.includes(skill.toLowerCase())) {\r\n                matchedKeywords.push(skill);\r\n                keywordMatches++;\r\n            }\r\n        }\r\n\r\n        const score = Math.min(40, keywordMatches * 8);\r\n\r\n        return {\r\n            score,\r\n            keywords: matchedKeywords.slice(0, 5)\r\n        };\r\n    }\r\n}\r\n\r\nexport async function GET(request: NextRequest) {\r\n    console.log('üîç RESULTS API CALLED - Fetching all candidates with matches...');\r\n\r\n    try {\r\n        const { searchParams } = new URL(request.url);\r\n        const jobId = searchParams.get('jobId');\r\n        const sortBy = searchParams.get('sortBy') || 'score';\r\n\r\n        // Read database\r\n        const dbData = await readFile('./uploads/database.json', 'utf-8');\r\n        const database = JSON.parse(dbData);\r\n\r\n        const candidates = database.candidates || [];\r\n        const jobs = database.jobs?.filter((job: any) => job.isActive !== false) || [];\r\n\r\n        if (candidates.length === 0 || jobs.length === 0) {\r\n            return NextResponse.json({\r\n                success: true,\r\n                candidates: [],\r\n                stats: {\r\n                    totalCVs: candidates.length,\r\n                    totalJobs: jobs.length,\r\n                    totalCandidates: 0\r\n                }\r\n            });\r\n        }\r\n\r\n        // Filter jobs if jobId is specified\r\n        const targetJobs = jobId\r\n            ? jobs.filter((job: any) => job.id === jobId)\r\n            : jobs;\r\n\r\n        // Process candidates - SHOW ALL MATCHES\r\n        const candidatesWithMatches = [];\r\n\r\n        for (const candidate of candidates) {\r\n            const allMatches = [];\r\n\r\n            for (const job of targetJobs) {\r\n                const matchResult = MatchingEngine.calculateMatch(candidate, job);\r\n\r\n                // Include ALL matches, regardless of score\r\n                allMatches.push({\r\n                    jobId: job.id,\r\n                    jobTitle: job.title,\r\n                    department: job.department,\r\n                    location: job.location,\r\n                    score: matchResult.score,\r\n                    threshold: job.matchThreshold || 70,\r\n                    reasons: matchResult.reasons,\r\n                    matchedSkills: matchResult.matchedSkills\r\n                });\r\n            }\r\n\r\n            // Sort matches by score (highest first)\r\n            allMatches.sort((a, b) => b.score - a.score);\r\n\r\n            candidatesWithMatches.push({\r\n                id: candidate.id,\r\n                fileId: candidate.fileId,\r\n                name: candidate.name,\r\n                email: candidate.email,\r\n                phone: candidate.phone,\r\n                experience: candidate.experience,\r\n                skills: candidate.skills,\r\n                licenses: candidate.licenses,\r\n                location: candidate.location,\r\n                matches: allMatches,\r\n                highestScore: allMatches.length > 0 ? allMatches[0].score : 0,\r\n                totalMatches: allMatches.length\r\n            });\r\n        }\r\n\r\n        // Sort results\r\n        switch (sortBy) {\r\n            case 'name':\r\n                candidatesWithMatches.sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n                break;\r\n            case 'experience':\r\n                candidatesWithMatches.sort((a: any, b: any) => b.experience - a.experience);\r\n                break;\r\n            case 'score':\r\n            default:\r\n                candidatesWithMatches.sort((a: any, b: any) => b.highestScore - a.highestScore);\r\n                break;\r\n        }\r\n\r\n        const stats = {\r\n            totalCVs: candidates.length,\r\n            totalJobs: targetJobs.length,\r\n            totalCandidates: candidatesWithMatches.length,\r\n            matchRate: Math.round((candidatesWithMatches.length / candidates.length) * 100)\r\n        };\r\n\r\n        console.log(`‚úÖ Results fetched:`, stats);\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            candidates: candidatesWithMatches,\r\n            stats,\r\n            filters: {\r\n                jobId,\r\n                sortBy\r\n            }\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('‚ùå Results API error:', error);\r\n        return NextResponse.json(\r\n            {\r\n                success: false,\r\n                error: 'Failed to fetch results',\r\n                details: error instanceof Error ? error.message : 'Unknown error'\r\n            },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}