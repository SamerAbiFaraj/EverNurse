{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/EverNurse-Project/evernurse-cv-matcher/src/app/api/matching/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { readFile, writeFile } from 'fs/promises';\r\n\r\n// Helper function to get jobs from database\r\nasync function getActiveJobs() {\r\n    try {\r\n        const db = await readFile('./uploads/database.json', 'utf-8');\r\n        const database = JSON.parse(db);\r\n\r\n        // Get active jobs from database\r\n        const jobs = database.jobs?.filter((job: any) => job.isActive !== false) || [];\r\n\r\n        // If no jobs in database, return default mock jobs for backward compatibility\r\n        if (jobs.length === 0) {\r\n            console.log('‚ö†Ô∏è No jobs in database, using fallback mock jobs');\r\n            return [\r\n                {\r\n                    id: 'job-1',\r\n                    title: 'Registered Nurse - ICU',\r\n                    department: 'Critical Care',\r\n                    location: 'Dubai',\r\n                    requiredSkills: ['ICU', 'Emergency Care', 'Patient Assessment'],\r\n                    requiredLicenses: ['DHA', 'DOH'],\r\n                    minExperience: 3,\r\n                    description: 'ICU Nurse with critical care experience'\r\n                },\r\n                {\r\n                    id: 'job-2',\r\n                    title: 'Pediatric Nurse',\r\n                    department: 'Pediatrics',\r\n                    location: 'Abu Dhabi',\r\n                    requiredSkills: ['Pediatrics', 'Patient Care'],\r\n                    requiredLicenses: ['DOH', 'MOH'],\r\n                    minExperience: 2,\r\n                    description: 'Pediatric nurse for children hospital'\r\n                }\r\n            ];\r\n        }\r\n\r\n        return jobs;\r\n    } catch (error) {\r\n        console.error('‚ùå Error loading jobs:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\nclass MatchingEngine {\r\n    static calculateMatch(candidate: any, job: any) {\r\n        let score = 0;\r\n        const reasons = [];\r\n\r\n        // Experience match (30 points max)\r\n        if (candidate.experience >= job.minExperience) {\r\n            const expScore = Math.min(30, (candidate.experience / job.minExperience) * 20);\r\n            score += expScore;\r\n            reasons.push(`Experience: ${candidate.experience} years`);\r\n        }\r\n\r\n        // Skills match (40 points max)\r\n        let skillsScore = 0;\r\n        const matchedSkills = candidate.skills.filter((skill: string) =>\r\n            job.requiredSkills.some((reqSkill: string) =>\r\n                reqSkill.toLowerCase().includes(skill.toLowerCase()) ||\r\n                skill.toLowerCase().includes(reqSkill.toLowerCase())\r\n            )\r\n        );\r\n\r\n        if (matchedSkills.length > 0 && job.requiredSkills.length > 0) {\r\n            skillsScore = (matchedSkills.length / job.requiredSkills.length) * 40;\r\n            score += skillsScore;\r\n            reasons.push(`Skills: ${matchedSkills.join(', ')}`);\r\n        } else if (job.requiredSkills.length === 0) {\r\n            // Fallback: Analyze job description for keywords\r\n            const descriptionScore = this.analyzeJobDescription(candidate, job);\r\n            score += descriptionScore.score;\r\n            if (descriptionScore.keywords.length > 0) {\r\n                reasons.push(`Matched keywords: ${descriptionScore.keywords.join(', ')}`);\r\n            }\r\n        }\r\n\r\n        // License match (30 points max)\r\n        let licenseScore = 0;\r\n        const matchedLicenses = candidate.licenses.filter((license: string) =>\r\n            job.requiredLicenses.includes(license)\r\n        );\r\n\r\n        if (matchedLicenses.length > 0 && job.requiredLicenses.length > 0) {\r\n            licenseScore = (matchedLicenses.length / job.requiredLicenses.length) * 30;\r\n            score += licenseScore;\r\n            reasons.push(`Licenses: ${matchedLicenses.join(', ')}`);\r\n        }\r\n\r\n        return {\r\n            score: Math.min(100, Math.round(score)),\r\n            reasons,\r\n            matchedSkills,\r\n            missingRequirements: this.findMissingRequirements(candidate, job)\r\n        };\r\n    }\r\n\r\n    static analyzeJobDescription(candidate: any, job: any) {\r\n        // Extract keywords from job title and description\r\n        const jobText = `${job.title} ${job.description}`.toLowerCase();\r\n        const candidateText = candidate.rawText.toLowerCase();\r\n\r\n        // Common keywords to look for\r\n        const keywords = [\r\n            'project management', 'banking', 'credit card', 'fintech', 'it', 'software',\r\n            'development', 'database', 'cloud', 'leadership', 'management', 'strategy',\r\n            'planning', 'agile', 'scrum', 'api', 'integration', 'consulting',\r\n            'nursing', 'healthcare', 'patient care', 'clinical', 'emergency'\r\n        ];\r\n\r\n        const matchedKeywords: string[] = [];\r\n        let keywordMatches = 0;\r\n\r\n        for (const keyword of keywords) {\r\n            if (jobText.includes(keyword) && candidateText.includes(keyword)) {\r\n                matchedKeywords.push(keyword);\r\n                keywordMatches++;\r\n            }\r\n        }\r\n\r\n        // Also check if candidate skills appear in job description\r\n        for (const skill of candidate.skills) {\r\n            if (jobText.includes(skill.toLowerCase()) && !matchedKeywords.includes(skill.toLowerCase())) {\r\n                matchedKeywords.push(skill);\r\n                keywordMatches++;\r\n            }\r\n        }\r\n\r\n        // Calculate score: up to 40 points based on keyword matches\r\n        const score = Math.min(40, keywordMatches * 8);\r\n\r\n        return {\r\n            score,\r\n            keywords: matchedKeywords.slice(0, 5) // Limit to top 5 for display\r\n        };\r\n    }\r\n\r\n    static findMissingRequirements(candidate: any, job: any) {\r\n        const missing = [];\r\n\r\n        if (candidate.experience < job.minExperience) {\r\n            missing.push(`Needs ${job.minExperience - candidate.experience} more years experience`);\r\n        }\r\n\r\n        const missingLicenses = job.requiredLicenses.filter((license: string) =>\r\n            !candidate.licenses.includes(license)\r\n        );\r\n\r\n        if (missingLicenses.length > 0) {\r\n            missing.push(`Missing licenses: ${missingLicenses.join(', ')}`);\r\n        }\r\n\r\n        return missing;\r\n    }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        const { candidateId } = await request.json();\r\n\r\n        if (!candidateId) {\r\n            return NextResponse.json({ error: 'Candidate ID required' }, { status: 400 });\r\n        }\r\n\r\n        // Read database\r\n        const dbContent = await readFile('./uploads/database.json', 'utf-8');\r\n        const database = JSON.parse(dbContent);\r\n\r\n        // Find candidate\r\n        const candidate = database.candidates.find((c: any) => c.id === candidateId);\r\n\r\n        if (!candidate) {\r\n            return NextResponse.json({ error: 'Candidate not found' }, { status: 404 });\r\n        }\r\n\r\n        console.log(`üéØ Matching candidate: ${candidate.name}`);\r\n\r\n        // Get active jobs from database\r\n        const jobs = await getActiveJobs();\r\n\r\n        if (jobs.length === 0) {\r\n            console.log('‚ö†Ô∏è No active jobs available for matching');\r\n            return NextResponse.json({\r\n                success: true,\r\n                candidate: candidate.name,\r\n                matches: [],\r\n                message: 'No active jobs available for matching'\r\n            });\r\n        }\r\n\r\n        // Calculate matches with all jobs\r\n        const matches = jobs.map(job => {\r\n            const matchResult = MatchingEngine.calculateMatch(candidate, job);\r\n\r\n            return {\r\n                jobId: job.id,\r\n                jobTitle: job.title,\r\n                department: job.department,\r\n                location: job.location,\r\n                ...matchResult\r\n            };\r\n        });\r\n\r\n        // Store matches in database\r\n        if (!database.matches) database.matches = [];\r\n\r\n        matches.forEach(match => {\r\n            database.matches.push({\r\n                id: `match-${Date.now()}-${match.jobId}`,\r\n                candidateId: candidate.id,\r\n                ...match,\r\n                matchedAt: new Date().toISOString()\r\n            });\r\n        });\r\n\r\n        // Save database\r\n        await writeFile('./uploads/database.json', JSON.stringify(database, null, 2));\r\n\r\n        console.log(`‚úÖ Found ${matches.length} potential matches for ${candidate.name}`);\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            candidate: candidate.name,\r\n            matches,\r\n            message: `Found ${matches.length} potential job matches`\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('‚ùå Matching error:', error);\r\n        return NextResponse.json(\r\n            { error: 'Matching failed' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}"],"names":[],"mappings":"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"}}]
}